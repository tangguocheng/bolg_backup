<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="曾经沧海难为水，除却巫山不是云"><title>IIC | 树下石</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><script type="text/javascript" src="/js/jquery.leoweather.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.5.2/APlayer.min.js"></script></head><body></body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">IIC</h1><a id="logo" href="/.">树下石</a><p class="description">不积跬步，无以至千里。<br/>不积小流，无以成江海。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-book"> 文章</i></a><a href="/holiday/"><i class="fa fa-heart"> 节日</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1"><div class="content_container"><div class="post"><h1 class="post-title">IIC</h1><div class="post-meta">Aug 9, 2016<span> | </span><span class="category"><a href="/categories/总线协议/">总线协议</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv">  <span id="busuanzi_value_page_pv"></span><span> 次阅读</span></span></div><a data-thread-key="2016/08/09/IIC/" href="/2016/08/09/IIC/#comments" class="ds-thread-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#总线结构"><span class="toc-number">1.</span> <span class="toc-text">总线结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#物理层"><span class="toc-number">2.</span> <span class="toc-text">物理层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总线协议-以24Cxx系列EEPROM为例"><span class="toc-number">3.</span> <span class="toc-text">总线协议(以24Cxx系列EEPROM为例)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#写操作"><span class="toc-number">3.1.</span> <span class="toc-text">写操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#读操作"><span class="toc-number">3.2.</span> <span class="toc-text">读操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#示例代码"><span class="toc-number">3.2.1.</span> <span class="toc-text">示例代码</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><script src="/assets/js/APlayer.min.js"> </script><p>I<sup>2</sup>C总线是一个多主(从)机、单端、串行通信总线，由飞利浦公司(现在的NXP公司)发明。典型应用是那些短距、低速的应用场合。使用I<sup>2</sup>C是不需要许可费的，但是如果使用NXP提供的地址字段，则需要支付相关费用。</p>
<h2 id="总线结构"><a href="#总线结构" class="headerlink" title="总线结构"></a>总线结构</h2><p>I<sup>2</sup>C是双向开漏两线制总线，由电阻上拉。SDA是其串行数据线，SCL是总线时钟线，用以提供时钟基准。I<sup>2</sup>C地址空间有7bit和10bit两种，大多数I<sup>2</sup>C提供100kbit/s的通信速率，当然这些都不是标准的一部分，视具体应用而定。鉴于通信帧中包含从机地址、从机应答等信息，实际的数据通信速率会比标称的峰值速率低。</p>
<p>最大的从机数目由地址空间的位数决定，同时总线上的电容大小总和受到400PF的限制，这限制了实际的通信距离只有几米，同时为了保证高阻抗和低噪声，一个共同的地也是潜在的需求，这会限制线路板的设计。</p>
<h2 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h2><p>在物理层上，SCL与SDA都是开漏设计，因此需要一个上拉电阻，将总线拉低来设置逻辑”0”,悬浮时总线被设置成逻辑”1”,是一个线与逻辑，总线上的任何一个设备拉低总线都会导致总线为低，因此当总线为低时，必定有其他设备在使用总线，此时总线为<code>BUSY</code>状态，因此设备可以依靠<code>SDA</code>避免总线冲突。</p>
<p>当总线空闲时，两条线都是高状态，启动一次传输，可以通过拉低SDA而保持SCL为高发出<code>START</code>信号，释放SDA而保持SCL为高将产生<code>STOP</code>信号。除了<code>START</code>与<code>STOP</code>信号，SDA需保持其状态在SCL为低时，仅当SCL为高时允许切换SDA状态。<br>当SCL为低时，由发送器将SDA状态切换至下一状态，然后主机将SCL设置成高电平，一旦SCL为高，接收器读取SDA状态。</p>
<h2 id="总线协议-以24Cxx系列EEPROM为例"><a href="#总线协议-以24Cxx系列EEPROM为例" class="headerlink" title="总线协议(以24Cxx系列EEPROM为例)"></a>总线协议(以24Cxx系列EEPROM为例)</h2><p>I<sup>2</sup>C总线的一个典型应用即是EEPROM。24Cxx系列存储芯片的操作主要有读写两类(有些芯片还有擦除操作，因为比较特殊，同时写操作同样可以达到同样目的，在此按下不表)。读写操作使用同样的通信协议:先写从机地址，接着传输数据直到结束信号到来。</p>
<center><img src="http://obd6jz6in.bkt.clouddn.com/IIC.jpg"></center>

<h3 id="写操作"><a href="#写操作" class="headerlink" title="写操作"></a>写操作</h3><p>首先主机发送开始信号<code>START</code>唤醒总线上的从机，接着发送从机地址(包含写信息)，从机在接收到之后与自己的地址信息进行比较，如果匹配则准备接收数据，否则忽略数据。接着发送需要写入的数据地址及数据，最后发送停止信号。从机在此期间将执行自己的状态机完成数据的接收与写入。<em>(需要注意的是24Cxx系列的EEPROM没法跨页写，也就是对于跨页写入的数据需要执行两次写周期)</em>写入期间，从机一只处在<code>BUSY</code>状态，对外界一切信息均不作响应，写入完成后从机响应ACK信号。</p>
<h3 id="读操作"><a href="#读操作" class="headerlink" title="读操作"></a>读操作</h3><p>与写操作类似，首先主机发送开始信号<code>START</code>唤醒总线上的从机，接着发送从机地址(包含写信息)，从机在接收到之后与自己的地址信息进行比较，如果匹配则准备接收数据，否则忽略数据。然后再次发送<code>START</code>信号与从机地址(包含读信息)，从机在收到后返回相应数据，主机在收到数据后发送应带<code>ACK</code>或者<code>NCK</code>通知从机接着接收完成或发送下一字节数据，从机发送完最后一个字节数据后，主机可不响应应答信号。</p>
<h4 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//函数声明</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Delay_EEPROM</span><span class="params">(<span class="keyword">void</span>)</span></span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">EEPROM_I2C_Init</span><span class="params">(<span class="keyword">void</span>)</span></span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">EEPROM_I2C_Start</span><span class="params">(<span class="keyword">void</span>)</span></span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">EEPROM_I2C_Stop</span><span class="params">(<span class="keyword">void</span>)</span></span>;</div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">EEPROM_ReceiveByte</span><span class="params">( <span class="keyword">unsigned</span> <span class="keyword">char</span> ACK )</span></span>;</div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">EEPROM_SendByte</span><span class="params">( <span class="keyword">unsigned</span> <span class="keyword">char</span> Data )</span></span>;</div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">I2C_Read</span><span class="params">( <span class="keyword">unsigned</span> <span class="keyword">char</span>* RAM_Addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> EEPROM_Addr, <span class="keyword">unsigned</span> <span class="keyword">char</span> Lenth )</span></span>;</div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">I2C_Write</span><span class="params">( <span class="keyword">unsigned</span> <span class="keyword">int</span> EEPROM_Addr, <span class="keyword">unsigned</span> <span class="keyword">char</span>* RAM_Addr, <span class="keyword">unsigned</span> <span class="keyword">char</span> Lenth )</span></span>;</div><div class="line"></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="comment">/*  函数名称：Delay_EEPROM                                             */</span></div><div class="line"><span class="comment">/*  函数功能：延时子程序                                               */</span></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Delay_EEPROM</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="number">_</span>NOP();<span class="number">_</span>NOP();</div><div class="line">    <span class="number">_</span>NOP();<span class="number">_</span>NOP();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="comment">/*  函数名称：EEPROM_I2C_Init                                          */</span></div><div class="line"><span class="comment">/*  函数功能：I2C管脚初始化                                            */</span></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">EEPROM_I2C_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    IO_EEPROM_SCL_OUT_H;</div><div class="line">    IO_EEPROM_SDA_OUT_H;</div><div class="line">    IO_EEPROM_SCL_DIR_OUT;</div><div class="line">    IO_EEPROM_SDA_DIR_OUT;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="comment">/*  函数名称：EEPROM_I2C_Start                                         */</span></div><div class="line"><span class="comment">/*  函数功能：启动I2C总线                                              */</span></div><div class="line"><span class="comment">/*  描述：SCL为高电平时，SDA发出下降沿信号                             */</span></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">EEPROM_I2C_Start</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    IO_EEPROM_SDA_OUT_H;      	<span class="comment">//SDA=1</span></div><div class="line">    Delay_EEPROM();</div><div class="line">    IO_EEPROM_SCL_OUT_H;      	<span class="comment">//SCL=1</span></div><div class="line">    Delay_EEPROM();</div><div class="line">    IO_EEPROM_SDA_OUT_L;	        <span class="comment">//SDA=0</span></div><div class="line">    Delay_EEPROM();</div><div class="line">    IO_EEPROM_SCL_OUT_L;      	<span class="comment">//SCL=0</span></div><div class="line">    Delay_EEPROM();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="comment">/*  函数名称：EEPROM_I2C_Stop                                          */</span></div><div class="line"><span class="comment">/*  函数功能：停止I2C总线                                              */</span></div><div class="line"><span class="comment">/*  描述：SCL为高电平时，SDA发出上升沿信号                             */</span></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">EEPROM_I2C_Stop</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    IO_EEPROM_SDA_OUT_L;      	<span class="comment">//SDA=0</span></div><div class="line">    Delay_EEPROM();</div><div class="line">    IO_EEPROM_SCL_OUT_H;      	<span class="comment">//SCL=1</span></div><div class="line">    Delay_EEPROM();</div><div class="line">    IO_EEPROM_SDA_OUT_H;	    <span class="comment">//SDA=1</span></div><div class="line">    Delay_EEPROM();</div><div class="line">    </div><div class="line">    IO_EEPROM_SDA_DIR_OUT;</div><div class="line">    IO_EEPROM_SCL_DIR_OUT;</div><div class="line">    IO_EEPROM_SDA_OUT_H;</div><div class="line">    IO_EEPROM_SCL_OUT_H;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="comment">/*  函数名称：EEPROM_ReceiveByte                                       */</span></div><div class="line"><span class="comment">/*  函数功能：接收一个字节数据，并发送应答信号                         */</span></div><div class="line"><span class="comment">/*  描述：在SCL高电平时，读取SDA信号                                   */</span></div><div class="line"><span class="comment">/*  输入参数：ACK：应答信号                                            */</span></div><div class="line"><span class="comment">/*  输出参数：读取数据                                                 */</span></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">EEPROM_ReceiveByte</span><span class="params">( <span class="keyword">unsigned</span> <span class="keyword">char</span> ACK )</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> i,Data=<span class="number">0x00</span>;</div><div class="line">    </div><div class="line">    IO_EEPROM_SDA_DIR_IN;     	   <span class="comment">//SDA输入</span></div><div class="line">    <span class="keyword">for</span>( i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++ )</div><div class="line">    &#123;</div><div class="line">        IO_EEPROM_SCL_OUT_H;       <span class="comment">//SCL=1</span></div><div class="line">        Delay_EEPROM();</div><div class="line">        Data = Data&lt;&lt;<span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span>( IO_EEPROM_SDA_IN)</div><div class="line">        &#123;</div><div class="line">            Data |= <span class="number">0x01</span>;</div><div class="line">        &#125;</div><div class="line">        IO_EEPROM_SCL_OUT_L;       <span class="comment">//SCL=0</span></div><div class="line">        Delay_EEPROM();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//发送应答位</span></div><div class="line">    IO_EEPROM_SDA_DIR_OUT;     	   <span class="comment">//SDA输出</span></div><div class="line">    <span class="keyword">if</span>( ACK == <span class="number">1</span> )</div><div class="line">    &#123;</div><div class="line">        IO_EEPROM_SDA_OUT_H;	   <span class="comment">//SDA=1</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        IO_EEPROM_SDA_OUT_L;	   <span class="comment">//SDA=0</span></div><div class="line">    &#125;</div><div class="line">    IO_EEPROM_SCL_OUT_H;           <span class="comment">//SCL=1</span></div><div class="line">    Delay_EEPROM();</div><div class="line">    IO_EEPROM_SCL_OUT_L;           <span class="comment">//SCL=0</span></div><div class="line">    </div><div class="line">    <span class="keyword">return</span> Data;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="comment">/*  函数名称：EEPROM_SendByte                                          */</span></div><div class="line"><span class="comment">/*  函数功能：发送一个字节数据或地址，并判断应答信号                   */</span></div><div class="line"><span class="comment">/*  描述：在SCL下降沿时，发送SDA信号                                   */</span></div><div class="line"><span class="comment">/*  输入参数：Data：待发送的信息                                       */</span></div><div class="line"><span class="comment">/*  输出参数：0为成功，1为失败                                         */</span></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">EEPROM_SendByte</span><span class="params">( <span class="keyword">unsigned</span> <span class="keyword">char</span> Data )</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> i,ACK;</div><div class="line">    </div><div class="line">    <span class="keyword">for</span>( i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++ )</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span>( Data &amp; <span class="number">0x80</span> )</div><div class="line">        &#123;</div><div class="line">            IO_EEPROM_SDA_DIR_IN;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            IO_EEPROM_SDA_DIR_OUT;</div><div class="line">            IO_EEPROM_SDA_OUT_L;</div><div class="line">        &#125;</div><div class="line">        IO_EEPROM_SCL_OUT_H;      	<span class="comment">//SCL=1</span></div><div class="line">        Delay_EEPROM();</div><div class="line">        Delay_EEPROM();</div><div class="line">        IO_EEPROM_SCL_OUT_L;      	<span class="comment">//SCL=0</span></div><div class="line">        Data=Data&lt;&lt;<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//应答位检查</span></div><div class="line">    IO_EEPROM_SDA_DIR_IN;     	<span class="comment">//SDA输入</span></div><div class="line">    Delay_EEPROM();</div><div class="line">    IO_EEPROM_SCL_OUT_H;          	<span class="comment">//SCL=1</span></div><div class="line">    Delay_EEPROM();</div><div class="line">    ACK = IO_EEPROM_SDA_IN;	        <span class="comment">//正常情况ACK信号应该为0</span></div><div class="line">    IO_EEPROM_SCL_OUT_L;          	<span class="comment">//SCL=0</span></div><div class="line">    IO_EEPROM_SDA_DIR_OUT;     	<span class="comment">//SDA输出</span></div><div class="line">    Delay_EEPROM();</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> ACK;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="comment">/*  函数名称：_E2Pread                                                 */</span></div><div class="line"><span class="comment">/*  函数功能：从EEPROM里读数据                                         */</span></div><div class="line"><span class="comment">/*  输入参数：RAM_Addr：目的地址                                       */</span></div><div class="line"><span class="comment">/*            EEPROM_Addr：源地址                                      */</span></div><div class="line"><span class="comment">/*            Lenth：数据长度                                          */</span></div><div class="line"><span class="comment">/*  输出参数：0为成功，其余为失败                                      */</span></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">I2C_Read</span><span class="params">( <span class="keyword">unsigned</span> <span class="keyword">char</span>* RAM_Addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> EEPROM_Addr, <span class="keyword">unsigned</span> <span class="keyword">char</span> Lenth )</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> ChipAddr,Addr,ACK,i=<span class="number">0</span>;</div><div class="line">    </div><div class="line">    ClrWdt();</div><div class="line">    EEPROM_I2C_Init();</div><div class="line">    EEPROM_I2C_Start();</div><div class="line">    </div><div class="line">    <span class="comment">//ChipAddr = 0xAE;</span></div><div class="line">    ChipAddr = (EEPROM_ICAddr | ((EEPROM_Addr&gt;&gt;<span class="number">13</span>)&amp;<span class="number">0x06</span>));</div><div class="line">    <span class="keyword">while</span>( i &lt; <span class="number">200</span> )<span class="comment">//判断EEPROM能否正常操作</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span>( EEPROM_SendByte(ChipAddr) == <span class="number">0</span> )<span class="comment">//发送器件地址</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        EEPROM_I2C_Stop();</div><div class="line">        EEPROM_I2C_Start();</div><div class="line">        i++;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>( i &gt;= <span class="number">200</span> )</div><div class="line">    &#123;</div><div class="line">        EEPROM_I2C_Stop();</div><div class="line">        Flag.Error |= F_EEPROM_Err;<span class="comment">//器件不正常</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0xFF</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        Flag.Error &amp;= ~F_EEPROM_Err;</div><div class="line">    </div><div class="line">    Addr = ((<span class="keyword">unsigned</span> <span class="keyword">char</span>)(EEPROM_Addr&gt;&gt;<span class="number">8</span>) &amp; <span class="number">0x3F</span>);</div><div class="line">    <span class="keyword">if</span>( EEPROM_SendByte(Addr) )<span class="comment">//发送子地址高位</span></div><div class="line">    &#123;</div><div class="line">        EEPROM_I2C_Stop();</div><div class="line">        Flag.Error |= F_EEPROM_Err;<span class="comment">//器件不正常</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0xFF</span>;</div><div class="line">    &#125;</div><div class="line">    Addr = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)EEPROM_Addr;</div><div class="line">    <span class="keyword">if</span>( EEPROM_SendByte(Addr) )<span class="comment">//发送子地址低位</span></div><div class="line">    &#123;</div><div class="line">        EEPROM_I2C_Stop();</div><div class="line">        Flag.Error |= F_EEPROM_Err;<span class="comment">//器件不正常</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0xFF</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    EEPROM_I2C_Start();</div><div class="line">    ChipAddr |= <span class="number">0x01</span>;</div><div class="line">    <span class="keyword">if</span>( EEPROM_SendByte(ChipAddr) )<span class="comment">//发送器件地址，读命令</span></div><div class="line">    &#123;</div><div class="line">        EEPROM_I2C_Stop();</div><div class="line">        Flag.Error |= F_EEPROM_Err;<span class="comment">//器件不正常</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0xFF</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span>( (Lenth--) &gt; <span class="number">0</span> )</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span>( Lenth != <span class="number">0</span> )</div><div class="line">            ACK = <span class="number">0</span>;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            ACK = <span class="number">1</span>;</div><div class="line">        *RAM_Addr = EEPROM_ReceiveByte(ACK);</div><div class="line">        RAM_Addr++;</div><div class="line">    &#125;</div><div class="line">    EEPROM_I2C_Stop();</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="comment">/*  函数名称：_E2Pwrite                                                */</span></div><div class="line"><span class="comment">/*  函数功能：往EEPROM里写数据                                         */</span></div><div class="line"><span class="comment">/*  输入参数：EEPROM_Addr：目的地址                                    */</span></div><div class="line"><span class="comment">/*            RAM_Addr：源地址                                         */</span></div><div class="line"><span class="comment">/*            Lenth：数据长度                                          */</span></div><div class="line"><span class="comment">/*  输出参数：0为成功，其余为失败                                      */</span></div><div class="line"><span class="comment">/***********************************************************************/</span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">I2C_Write</span><span class="params">( <span class="keyword">unsigned</span> <span class="keyword">int</span> EEPROM_Addr, <span class="keyword">unsigned</span> <span class="keyword">char</span>* RAM_Addr, <span class="keyword">unsigned</span> <span class="keyword">char</span> Lenth )</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> ChipAddr,Addr,i=<span class="number">0</span>;</div><div class="line">    </div><div class="line">    ClrWdt();</div><div class="line">    EEPROM_I2C_Init();</div><div class="line">    EEPROM_I2C_Start();</div><div class="line">    </div><div class="line">    <span class="comment">//ChipAddr = 0xAE;</span></div><div class="line">    ChipAddr = (EEPROM_ICAddr | ((EEPROM_Addr&gt;&gt;<span class="number">13</span>)&amp;<span class="number">0x06</span>));</div><div class="line">    <span class="comment">//EEPROM在完成一次写入命令后要延迟5到10毫秒，通过连续发器件地址，一旦总线正常，即立刻进行下一次总线操作</span></div><div class="line">    <span class="keyword">while</span>( i &lt; <span class="number">200</span> )<span class="comment">//判断EEPROM能否正常操作</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span>( EEPROM_SendByte(ChipAddr) == <span class="number">0</span> )<span class="comment">//发送器件地址</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        EEPROM_I2C_Stop();</div><div class="line">        EEPROM_I2C_Start();</div><div class="line">        i++;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>( i &gt;= <span class="number">200</span> )</div><div class="line">    &#123;</div><div class="line">        EEPROM_I2C_Stop();</div><div class="line">        Flag.Error |= F_EEPROM_Err;<span class="comment">//器件不正常</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0xFF</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        Flag.Error &amp;= ~F_EEPROM_Err;</div><div class="line">    </div><div class="line">    Addr = ((<span class="keyword">unsigned</span> <span class="keyword">char</span>)(EEPROM_Addr&gt;&gt;<span class="number">8</span>) &amp; <span class="number">0x3F</span>);</div><div class="line">    <span class="keyword">if</span>( EEPROM_SendByte(Addr) )<span class="comment">//发送子地址高位</span></div><div class="line">    &#123;</div><div class="line">        EEPROM_I2C_Stop();</div><div class="line">        Flag.Error |= F_EEPROM_Err;<span class="comment">//器件不正常</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0xFF</span>;</div><div class="line">    &#125;</div><div class="line">    Addr = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)EEPROM_Addr;</div><div class="line">    <span class="keyword">if</span>( EEPROM_SendByte(Addr) )<span class="comment">//发送子地址低位</span></div><div class="line">    &#123;</div><div class="line">        EEPROM_I2C_Stop();</div><div class="line">        Flag.Error |= F_EEPROM_Err;<span class="comment">//器件不正常</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0xFF</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">do</span></div><div class="line">    &#123;</div><div class="line">        EEPROM_SendByte(*RAM_Addr);</div><div class="line">        RAM_Addr++;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span>( (--Lenth) &gt; <span class="number">0</span> );</div><div class="line">    EEPROM_I2C_Stop();</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/总线协议/">总线协议</a></div><div class="post-nav"><a href="/2016/08/09/TTL-CMOS/" class="pre">TTL电平,CMOS电平,OC门,OD门基础知识</a><a href="/2016/08/08/STM8-REST/" class="next">STM8复位(reset)</a></div><div data-thread-key="2016/08/09/IIC/" data-title="IIC" data-url="http://www.xn--4gqa63c686ta68iba.ren/2016/08/09/IIC/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/08/09/IIC/" data-title="IIC" data-url="http://www.xn--4gqa63c686ta68iba.ren/2016/08/09/IIC/" data-author-key="1" class="ds-thread"></div></div></div></div></div><div class="pure-u-1"><div id="footer">©2016 <a href="/." rel="nofollow">树下石.</a><a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Maupassant.</a><script type="text/javascript" src="https://s4.cnzz.com/z_stat.php?id=1260102884&amp;web_id=1260102884" language="JavaScript"></script></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'tangguocheng'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-80700049-1','auto');ga('send','pageview');
</script><script>$('.weather').leoweather({format:'{城市}今日天气 {天气} {夜间气温}℃ ~ {白天气温}℃'});
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></html>